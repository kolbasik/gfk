<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>GFK: small test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.96.1/css/materialize.min.css">
    <style>
        .console { height: 100px; overflow-y: scroll; background-color: #ddd; }
        .chart { min-width: 350px; height: 400px; margin: 0 auto }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <h1>GFK: small test</h1>
        <section data-item="task_1">
            <p>1) Write a program in any language that prints the numbers from 1 to 100. But for multiples of three print "Bizz" instead of the number and for the multiples of five print "Appz". For numbers which are multiples of both three and five print "BizzAppz".</p>
            <pre class="console"></pre>
        </section>
        <section data-item="task_2">
            <p>2) Write a class (prototype) in JavaScript, with at least one method, and another class which extends the previous class. Make sure that when an instance is created of the latter, it returns true for an instanceof-check for both prototypes and that the method on the first prototype can be invoked.</p>
            <pre class="console"></pre>
        </section>
        <section data-item="task_3">
            <p>3) Using the attached data, create a chart in JavaScript which shows a trend over time of the percentage of responses for that day which have a value of "yes" for the "answer" column.</p>
            <div class="chart"></div>
            <pre class="console"></pre>
        </section>
        <section data-item="task_4">
            <p>4) Use the two url's shown below to retrieve the strings they return and after they both complete, concatenate both strings in the correct order with a space in between and display the result.</p>
            <ul>
                <li>http://cdn.gfkdaphne.com/tests/async.php?a=1</li>
                <li>http://cdn.gfkdaphne.com/tests/async.php?a=2</li>
            </ul>
            <pre class="console"></pre>
        </section>
    </div>
</div>

<script src="https://lodash.com/_js/lodash.min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>

<script>

    var HTTP = {
        request: function (url) {
            return new Promise(function (resolve, reject) {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4) {
                        if (xhr.status == 200) {
                            resolve(xhr.responseText);
                        }
                        else {
                            reject(xhr.status);
                        }
                    }
                };
                xhr.open("GET", url, true);
                xhr.send();
            });
        }
    };

    var CSV = {
        parse: function (data, delimiter) {
            delimiter = delimiter || ';';
            var rows = data.split('\r\n'),
                headers = rows.shift().split(delimiter);

            rows.pop(); // NOTE: removes the redundant empty string

            return rows.map(function(row){
                var object={},
                    cells=row.split(delimiter);

                for(var i=0, il=headers.length; i<il; ++i) {
                    object[headers[i]] = cells[i];
                }

                return object;
            });
        }
    };

    (function(window, $){
        'use strict';

        var Output = function (container) {
            var $output = $("[data-item=" + container + "] .console:first");
            this.log = function(message) {
                $('<div></div>').html(message.toString()).appendTo($output);
            }
        };

        task1(new Output("task_1"));
        task2(new Output("task_2"));
        task3(new Output("task_3"));
        task4(new Output("task_4"));

        return;

        function task1(output) {
            for (var i = 1, il = 100; i <= il; ++i) {
                var message = '';
                if (i % 3 == 0) {
                    message += 'Bizz';
                }
                if (i % 5 == 0) {
                    message += 'Appz';
                }
                if (message) {
                    output.log(i + ": " + message);
                }
            }
        }

        function task2(output) {
            if (!Object.hasOwnProperty('create')) {
                Object.create = function (proto) {
                    function F() {}
                    F.prototype = proto;
                    return new F();
                };
            }

            var Human = function () {};
            Human.prototype.whoami = function() {
                return 'Human';
            };

            var Man = function () {};
            Man.prototype = Object.create(Human.prototype);
            Man.prototype.constructor = Man;

            var person = new Man();

            output.log("Human?: " + (person instanceof Human));
            output.log("Man?: " + (person instanceof Man));
            output.log("Who am I?: " + person.whoami());
        }

        function task3(output) {
            output.log('data.csv loading...');
            HTTP.request("data.csv").then(function (source) {

                output.log('data.csv parsing...');
                var data = CSV.parse(source);

                output.log('analyzing...');
                data = _.map(_.groupBy(data, _.property('DATE')), function(values, key) {
                    var positives = _.where(values, { 'ANSWER': 'yes' });
                    return { key: key, value: Math.round(positives.length * 100 / values.length) };
                });

                $('[data-item=task_3] .chart').highcharts({
                    title: {
                        text: 'Answers'
                    },
                    xAxis: {
                        categories: _.pluck(data, 'key')
                    },
                    yAxis: {
                        title: {
                            text: 'Percentage %'
                        },
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }]
                    },
                    tooltip: {
                        valueSuffix: '%'
                    },
                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle',
                        borderWidth: 0
                    },
                    series: [{
                        name: 'Yes',
                        data: _.pluck(data, 'value')
                    }]
                });

            });
        }

        function task4(output) {
            var requests = [
                HTTP.request("http://cdn.gfkdaphne.com/tests/async.php?a=1"),
                HTTP.request("http://cdn.gfkdaphne.com/tests/async.php?a=2")
            ];

            Promise.all(requests).then(function (data) {
                output.log(data.join(' '));
            });
        }

    })(window, jQuery);
</script>
</body>
</html>